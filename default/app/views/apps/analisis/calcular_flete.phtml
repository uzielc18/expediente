<?php
echo Tag::js('jquery/jquery.tokeninput');
Tag::css('token-input');?>
<script type="text/javascript">
$(document).ready(function() 
{
    $("#detalleanalisis_materiales_id").tokenInput("<?php echo '/'.$module_name.'/materiales/resultados'?>",
    {
        tokenLimit: 1,minChars: 3,
        <?php if(!empty($detalleanalisis->materiales_id)){?>
        prePopulate: [
                {id: <?php echo $detalleanalisis->materiales_id?>, name: "<?php echo $detalleanalisis->getMateriales()->getCodigoCompleto().' '.$detalleanalisis->getMateriales()->nombre?>"}
            ]
        <?php }?>
    });
});

</script>
<?php 
$exp_id = $partida->getPresupuestos()->getExpedientes()->expedientes_id;
$mod_id = $modulo->id;
$bloc_id = $partida->getPresupuestos()->expedientes_id;
$pres_id = $partida->presupuestos_id;?>
<section class="content">
	<div class="row">
	<?php View::partial('menu_expediente',false,array('expediente_id'=>$exp_id)) ?>
		<div class="col-md-12">
			<div class="box box-solid">
				<div class="box-header">
				    <h2 class="box-title"><?php echo $titulo?></h2>
				</div>
				<blockquote>
					<dl class="dl-horizontal">
				      <dt>Presupuesto: </dt><dd><?php echo $partida->getPresupuestos()->nombre?></dd>
				      <dt>Titulo: </dt><dd><?php echo $partida->getTitulopartidas()->titulo?></dd>
				      <dt>Medida: </dt><dd><?php echo $partida->getMedidas()->nombre?> (<?php echo $partida->getMedidas()->abr?>)</dd>
				  	</dl>
				</blockquote>
				<?Php 
				echo Form::open();
				echo Form::hidden('calculoflete.id');
				echo Form::hidden('calculoflete.detalleanalisis_id',NULL,$detalleanalisis_id);
				echo Form::textArea('calculoflete.items');
				echo Form::text('calculoflete.totalkg');
				?>
				<?php echo Form::submit('Calcular la suma ') ?>
				<?php echo Form::close()?>
				<div class="box-body">
					<?php print_r($array)?>
					<div class="col-sm-12">
						<br />						
						<div id="reporte-detalleanalisis">
							<table class="table table-condensed" style="font-size: 12px;">
								<caption>Detalle de flete</caption>
								<thead>
									<tr>
										<th>DESCRIPCION DE INSUMOS</th>
										<th>KG</th>
										<th>TM</th>
										<th>ORIGEN</th>
										<th>DESTINO</th>
										<th>F/TIPO/CARRETERA</th>
										<th>KM</th>
										<th>S/ X TM</th>
										<th title="FACTOR DE RETORNO AL VACIO">FRV</th>
										<th>S/ TM x FRV</th>
										<th>Rajuste K1</th>
										<th>S/. TM</th>
										<th>KM x TM</th>
										<th>TOTAL</th>
									</tr>
								</thead>
								<tbody>
									<tr>
										<td>
											<table class="table table-condensed">
												<thead>
													<tr><th>Nombre</th><th>U</th><th>Peso</th><th>Cant.</th><th>T</th><th>act</th></tr>
												</thead>
												<tbody id="body_array">
													
												</tbody>
											</table>
										</td>
										<td></td>
										<td></td>
										<td></td>
										<td></td>
										<td></td>
										<td></td>
										<td></td>
										<td></td>
										<td></td>
										<td></td>
										<td></td>
										<td></td>
										<td></td>
									</tr>
								</tbody>
								<tfoot>
									
								</tfoot>
							</table>
						</div>
					</div>
				</div>
				<div class="box-footer with-border">
					
				</div>

				<script type="text/javascript">
				$(document).ready(function(){
					var array_datos=<?Php echo $id==0 ? $array : $calculoflete->items;?>;
					var total_kg=0;
					function getdatos(a){
						$("#body_array").html("");
						a.forEach(function(element){
							console.log(element);
							var tr="<tr id='tr-"+element.id+"'><td>"+element.nombre+"</td><td>"+element.abr+"</td><td>"+element.peso+"</td><td>"+element.cantidad+"</td><td>"+Number(element.t).toFixed(2)+"</td><td><a href='javascript:;' class='eliminar_element' data-item='"+element.id+"'><i class='fa fa-trash' style='font-size:15px;'></a></td></tr>";

							total_kg = total_kg + Number(element.t);
						  $("#body_array").append(tr);
						});
						$('#calculoflete_totalkg').val(total_kg);
						$('#calculoflete_items').val(JSON.stringify(array_datos));
					}

					function eliminarPorId(id){
					  array_datos.forEach(function(currentValue, index, arr){
					  	console.log(array_datos[index].id,'===',id);
						if(array_datos[index].id===id){
							total_kg = total_kg - array_datos[index].t;
						    array_datos.splice(index, 1);
						    //console.log(array_datos);
						    $('#calculoflete_totalkg').val(total_kg);
						    $('#calculoflete_items').val(JSON.stringify(array_datos));
						    $("#tr-"+id).attr('style', 'display: none');
						}
					  });
					}

					getdatos(array_datos);
					$('.eliminar_element').click(function(event) {
						var val = $(this).attr('data-item');
						console.log(val);
						eliminarPorId(val);
					});

					$('#partida_detalleanalisis').val($("#reporte-detalleanalisis").html());
				});
				function calcular() {
				  var cantidad = $( "#detalleanalisis_cantidad" ).val();
				  var precio = $( "#detalleanalisis_precio" ).val();
				  return cantidad*precio;
				}
				$(".calcular").change(function() {
				  $("#detalleanalisis_parcial" ).val(calcular());
				});
				</script>
			</div>
		</div>
	</div>
</section>